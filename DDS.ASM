; TTL Logic Based Direct Digital Synthesis (DDS)
; Mike McCann KB2GHZ
; 2020 TAPR/DCC
;
		PROCESSOR	16F628A
		INCLUDE		<p16f628a.inc>
		__CONFIG	_WDT_OFF & _FOSC_HS & _MCLRE_ON
		ORG		__VECTOR_RESET
		GOTO		START	; POWER ON RESET
		ORG		__VECTOR_INT
		GOTO		ISR	; INTERRUPT HANDLER
;
START:		CALL		HWINIT	; SETUP HARDWARE
MESG:		CALL		STARTMES
REPL:		CALL		GETCMD	; ACCEPT COMMAND
		CALL		RUNCMD	; EXECUTE COMMAND
;		GOTO		REPL
		GOTO		MESG

		PAGE
; DISPLAY A STARTUP MESSAGE ON THE CONSOLE
STARTMES:	MOVLW		'D'
		CALL		OUTCH
		MOVLW		'D'
		CALL		OUTCH
		MOVLW		'S'
		CALL		OUTCH
		MOVLW		0X20	; ASCII SPACE
		CALL		OUTCH
		MOVLW		'V'
		CALL		OUTCH
		MOVLW		'1'
		CALL		OUTCH
		MOVLW		'.'
		CALL		OUTCH
		MOVLW		'1'
		CALL		OUTCH
		MOVLW		0X0D	; ASCII LF
		CALL		OUTCH
		MOVLW		0X0A	; ASCII CR
		CALL		OUTCH
		RETURN
		
		PAGE
; INPUT A COMMAND
GETCMD:		MOVLW		'*'	; COMMAND PROMPT
		CALL		OUTCH
GETCMD1:	CALL		GETCH
		ANDLW		0XDF
		CALL		OUTCH	
		GOTO		GETCMD1
		RETURN

; EXECUTE A COMMAND
RUNCMD:		NOP
		RETURN

		PAGE
; OUTPUT CHARACTER PASSED IN W ON THE SERIAL PORT
OUTCH:		BSF		STATUS,RP0	; ** BANK 1 **
POLL:		BTFSS		TXSTA,TRMT	; POLL SHIFT REGISTER STATUS
		GOTO		POLL
		BCF		STATUS,RP0	; ** BANK 0 **
		MOVWF		TXREG		; TX DATA REGISTER
		RETURN

; RETURN A CHARACTER FROM THE SERIAL PORT IN W
GETCH:		BTFSS		PIR1,RCIF	; DATA AVAILABLE?
		GOTO		GETCH
		MOVFW		RCREG		; GET RECEIVED CHARACTER
		RETURN


PAUSE:		NOP
		RETURN

		PAGE

HWINIT:
; CONFIGURE THE SERIAL PORT FOR 9600 BPS, 1 STOP BIT, NO PARITY
		MOVLW		B'10010000'
		MOVWF		RCSTA	; RECEIVE CONTROL REGISTER
		MOVLW		B'00100100'
		BSF		STATUS,RP0 ; ** BANK 1 **
		MOVWF		TXSTA	; TRANSMIT CONTROL REGISTER
		MOVLW		0x40	; BGRH=1
		MOVWF		SPBRG	; DIVIDER FOR BRG - 9600 BPS
; CONFIGURE PINS RB2 & RB1 AS SERIAL TX AND RX
		BSF		TRISB,TRISB1
		BSF		TRISB,TRISB2
; CONFIGURE PINS RA0, RA1, RA2, AND RA3 AS OUTPUTS
		BCF		TRISA,TRISA0	; RA0 TW RESET
		BCF		TRISA,TRISA1	; RA1 TW CLOCK
		BCF		TRISA,TRISA2	; RA2 TW DATA
		BCF		TRISA,TRISA3	; RA3 ACCUMULATOR RESET
		BCF		STATUS,RP0	; ** BANK 0 **
		RETURN

; INTERRUPT ROUTINE
ISR:		NOP
		RETFIE
		END

